<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Prompt Studio (Standalone)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
  /* ===== Full-screen Responsive Layout (standalone) ===== */
  :root{
    --tx-primary:#0AA0A6;
    --line:#d7e7f7;
    --chip-bg:#eef6fa; --chip-ink:#247;
    --muted:#5e6b7a; --panel:#fff; --bg:#f6fafc;
    --radius:12px;
  }
  html,body{height:100%; margin:0;}
  body{font:14px/1.6 "Noto Sans JP", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:#123; background:var(--bg);}
  .app{height:100dvh; display:flex; flex-direction:column; min-width:960px;}

  /* ---------- Header ---------- */
  .ps-header{
    flex:0 0 auto; height:64px; display:grid;
    grid-template-columns: 1fr minmax(520px, 1.2fr) auto;
    align-items:center; gap:12px; padding:10px 14px;
    background:#fff; border-bottom:1px solid var(--line);
  }
  .ps-header .left{display:flex; align-items:center; gap:12px; min-width:0;}
  .app-title{margin:0; font-size:18px; white-space:nowrap;}
  .ps-header .middle{
    display:grid; grid-template-columns: auto 110px auto 110px auto minmax(280px,1fr);
    align-items:center; gap:8px; min-width:520px;
  }
  .label{font-size:12px; color:var(--muted); white-space:nowrap;}
  .ps-header .right{display:flex; gap:8px;}

  .input{background:#fff; border:1px solid var(--line); border-radius:8px; padding:8px 10px; min-width:0; outline:none;}
  .input.sm{padding:6px 8px;}
  .input.wide{width:100%;}
  .btn{background:var(--tx-primary); color:#fff; border:none; border-radius:10px; padding:9px 14px; cursor:pointer; font-weight:700;}
  .btn.secondary{background:#0d2330; color:#fff;}
  .btn.ghost{background:#fff; color:#0d2330; border:1px solid var(--line);}

  /* ---------- Main ---------- */
  .ps-main{
    flex:1 1 auto; min-height:0;            /* 子要素のoverflowを許可 */
    display:grid; grid-template-columns: clamp(260px, 18vw, 340px) 1fr; gap:16px;
    padding:16px; overflow:hidden;          /* 全体の二重スクロール防止 */
  }
  .panel{background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); min-height:0;}

  /* ---------- Sidebar ---------- */
  .ps-side{display:flex; flex-direction:column; min-width:0; resize:horizontal; overflow:auto;}
  .tips{color:var(--muted); padding:12px 12px 4px;}
  .ps-side .input{margin:0 12px 10px;}
  .filelist{padding:0 12px 12px; display:flex; flex-direction:column; gap:8px;}
  .fileitem{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer;}
  .fileitem.active{outline:2px solid #0aa0a633;}
  .fileitem .name{font-weight:700; color:#134; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
  .fileitem .meta{display:flex; gap:6px; align-items:center;}
  .chip{background:var(--chip-bg); color:var(--chip-ink); padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); white-space:nowrap;}
  .chip.ok{color:#066; background:#e7faf8; border-color:#b8efe9;}
  .chip.warn{color:#764f00; background:#fff5d6; border-color:#f4e1a4;}
  .chip.info{color:#124a7a; background:#e8f2ff; border-color:#cfe2ff;}

  /* ---------- Editor ---------- */
  .ps-editor{display:flex; flex-direction:column; min-width:0; min-height:0; overflow:hidden;}
  .bar.meta{
    flex:0 0 auto; display:grid; grid-template-columns: repeat(2, auto) repeat(2, auto) auto 1fr;
    align-items:center; gap:8px; padding:12px; border-bottom:1px solid var(--line);
  }
  .file-caption{color:var(--muted);}
  .filename{font-weight:700; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

  .tab-header{
    flex:0 0 auto; display:flex; gap:8px; padding:10px 12px; border-bottom:1px solid var(--line);
  }
  .tab-button{background:#f6fbff; border:1px solid var(--line); color:#134; border-radius:8px; padding:8px 12px; cursor:pointer;}
  .tab-button.active{background:#fff; border-bottom-color:#fff; font-weight:700;}

  .tab-wrap{flex:1 1 auto; min-height:0; display:flex; flex-direction:column; overflow:hidden;}
  .tab-panel{display:none; flex:1 1 auto; min-height:0; overflow:auto;}
  .tab-panel.active{display:block;}
  #promptTab{padding:12px; height:100%;}
  #promptEditor{
    width:100%; height:100%; min-height:0;
    border:1px solid var(--line); border-radius:10px; padding:12px;
    resize:none; box-sizing:border-box; background:#fbfeff;
    font:13px/1.7 ui-monospace, Menlo, Consolas, "Noto Sans JP";
    white-space:pre-wrap; overflow:auto;
  }

  /* ---------- Parameters ---------- */
  #paramsTab{padding:12px;}
  .param-grid{display:grid; grid-template-columns: repeat(2, minmax(320px, 1fr)); gap:16px;}
  .slider-group{background:#fcfeff; border:1px solid var(--line); border-radius:10px; padding:10px 12px;}
  .slider-label{display:flex; align-items:center; justify-content:space-between; gap:12px; white-space:nowrap;}
  .slider-value{color:#134; font-weight:700;}
  input[type="range"]{width:100%;}

  #statusMessage{flex:0 0 auto; padding:8px 12px; color:#0AA0A6;}

  /* ---------- Diff ---------- */
  .diff{flex:0 0 auto; border-top:1px dashed var(--line); padding:12px;}
  .diff-head{font-weight:700; color:#345; margin:.5em 0 10px;}
  .diff-cols{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
  .diff textarea{
    width:100%; height:240px; font:12px/1.6 ui-monospace, "Noto Sans JP";
    background:#f9fcff; border:1px dashed var(--line); border-radius:8px; padding:10px; resize:none;
  }

  /* ---------- Responsive ---------- */
  @media (max-width: 1200px){
    .param-grid{grid-template-columns: 1fr;}
  }
  @media (max-width: 1100px){
    .ps-header{grid-template-columns: 1fr; height:auto; row-gap:8px; padding:8px 14px;}
    .ps-main{grid-template-columns: clamp(240px, 22vw, 320px) 1fr;}
  }
  </style>
</head>
<body>
  <div class="app">
    <header class="ps-header">
      <div class="left">
        <a class="btn ghost" href="./client-editor.html" title="Client Catalogへ戻る">← 戻る</a>
        <h1 class="app-title">Prompt Studio</h1>
      </div>
      <div class="middle">
        <label class="label">Client</label>
        <input id="clientId" class="input sm" placeholder="A001" autocomplete="off" />
        <label class="label">Behavior</label>
        <select id="behavior" class="input sm">
          <option>BASE</option><option>TYPE-R</option><option>TYPE-S</option>
        </select>
        <label class="label">API Base</label>
        <input id="apiBase" class="input sm wide" placeholder="https://.../api" autocomplete="off" />
      </div>
      <div class="right">
        <button id="btnDiff" class="btn secondary">差分</button>
        <button id="btnSave" class="btn">保存 (Ctrl+S)</button>
      </div>
    </header>

    <main class="ps-main">
      <aside class="ps-side panel" id="sidebar">
        <div class="tips">クライアント別の編集対象を選択してください。</div>
        <input id="search" class="input" placeholder="ファイル検索…" />
        <div id="fileList" class="filelist" aria-label="ファイル一覧"></div>
      </aside>

      <section class="ps-editor panel">
        <div class="bar meta">
          <span>状態:</span> <span id="badgeState" class="chip">—</span>
          <span>ETag:</span>  <span id="badgeEtag" class="chip">—</span>
          <span class="file-caption">ファイル:</span>
          <span class="filename" id="fileTitle">未選択</span>
        </div>

        <div class="tab-header">
          <button class="tab-button active" id="tabPromptBtn">プロンプト</button>
          <button class="tab-button" id="tabParamsBtn">パラメータ</button>
        </div>

        <div class="tab-wrap">
          <div class="tab-panel active" id="promptTab">
            <textarea id="promptEditor" spellcheck="false" placeholder="ここにプロンプトが読み込まれます…"></textarea>
          </div>

          <div class="tab-panel" id="paramsTab">
            <div class="param-grid">
              <div class="slider-group">
                <div class="slider-label">入力補完トークンの最大数（100〜32768）
                  <span class="slider-value" id="val_max_tokens">800</span></div>
                <input type="range" id="param_max_tokens" min="100" max="32768" step="1" value="800" />
              </div>
              <div class="slider-group">
                <div class="slider-label">温度 [temperature]（0.00〜1.00）
                  <span class="slider-value" id="val_temperature">1.00</span></div>
                <input type="range" id="param_temperature" min="0" max="1" step="0.01" value="1.00" />
              </div>
              <div class="slider-group">
                <div class="slider-label">Top P（0.01〜1.00）
                  <span class="slider-value" id="val_top_p">1.00</span></div>
                <input type="range" id="param_top_p" min="0.01" max="1" step="0.01" value="1.00" />
              </div>
              <div class="slider-group">
                <div class="slider-label">頻度ペナルティ [frequency_penalty]（-2.00〜2.00）
                  <span class="slider-value" id="val_frequency_penalty">0.00</span></div>
                <input type="range" id="param_frequency_penalty" min="-2" max="2" step="0.01" value="0.00" />
              </div>
              <div class="slider-group">
                <div class="slider-label">プレゼンスペナルティ [presence_penalty]（-2.00〜2.00）
                  <span class="slider-value" id="val_presence_penalty">0.00</span></div>
                <input type="range" id="param_presence_penalty" min="-2" max="2" step="0.01" value="0.00" />
              </div>
              <div class="slider-group">
                <div class="slider-label">応答数 n（1〜4）
                  <span class="slider-value" id="val_n">1</span></div>
                <input type="range" id="param_n" min="1" max="4" step="1" value="1" />
              </div>
            </div>
          </div>
        </div>

        <div id="statusMessage" class="tips">ファイルを選択してください。</div>

        <div id="diffPanel" class="diff" hidden>
          <div class="diff-head">テンプレートとの差分（左：テンプレ / 右：現在）</div>
          <div class="diff-cols">
            <textarea id="diffLeft" readonly></textarea>
            <textarea id="diffRight" readonly></textarea>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
  /* ===== Full-screen Prompt Studio (auto layout) ===== */
  const DEV_API  = "https://func-texel-api-dev-jpe-001-b2f6fec8fzcbdrc3.japaneast-01.azurewebsites.net/api/";
  const PROD_API = "https://func-texel-api-prod-jpe-001-dsgfhtafbfbxawdz.japaneast-01.azurewebsites.net/api/";

  const KIND_TO_NAME = {
    "suumo-catch":   "texel-suumo-catch.json",
    "suumo-comment": "texel-suumo-comment.json",
    "roomphoto":     "texel-roomphoto.json",
    "suggestion":    "texel-suggestion.json",
    "athome-appeal": "texel-athome-appeal.json",
    "athome-comment":"texel-athome-comment.json",
  };
  const FAMILY = {
    "BASE":   new Set(["suumo-catch","suumo-comment","roomphoto","suggestion","athome-appeal","athome-comment"]),
    "TYPE-R": new Set(["suumo-catch","suumo-comment","roomphoto","suggestion","athome-appeal","athome-comment"]),
    "TYPE-S": new Set(["suumo-catch","suumo-comment","roomphoto","suggestion"])
  };

  const els = {
    clientId:  document.getElementById("clientId"),
    behavior:  document.getElementById("behavior"),
    apiBase:   document.getElementById("apiBase"),
    fileList:  document.getElementById("fileList"),
    search:    document.getElementById("search"),
    fileTitle: document.getElementById("fileTitle"),
    badgeState:document.getElementById("badgeState"),
    badgeEtag: document.getElementById("badgeEtag"),
    tabPromptBtn: document.getElementById("tabPromptBtn"),
    tabParamsBtn: document.getElementById("tabParamsBtn"),
    promptTab:    document.getElementById("promptTab"),
    paramsTab:    document.getElementById("paramsTab"),
    promptEditor: document.getElementById("promptEditor"),
    btnSave:   document.getElementById("btnSave"),
    btnDiff:   document.getElementById("btnDiff"),
    diffPanel: document.getElementById("diffPanel"),
    diffLeft:  document.getElementById("diffLeft"),
    diffRight: document.getElementById("diffRight"),
    status:    document.getElementById("statusMessage"),
  };

  let currentKind = null;
  let currentFilenameTarget = null;
  let currentEtag = null;
  let templateText = "";
  let loadedParams = {};
  let dirty = false;

  /* ---------- Tabs ---------- */
  function showTab(which){
    const isPrompt = which === "prompt";
    els.tabPromptBtn.classList.toggle("active", isPrompt);
    els.tabParamsBtn.classList.toggle("active", !isPrompt);
    els.promptTab.classList.toggle("active", isPrompt);
    els.paramsTab.classList.toggle("active", !isPrompt);
  }
  els.tabPromptBtn.addEventListener("click", ()=>showTab("prompt"));
  els.tabParamsBtn.addEventListener("click", ()=>showTab("params"));

  /* ---------- Param UI ---------- */
  const paramKeys = [
    ["max_tokens",         800],
    ["temperature",       1.00],
    ["top_p",             1.00],
    ["frequency_penalty", 0.00],
    ["presence_penalty",  0.00],
    ["n",                 1   ],
  ];
  function writeParamUI(params){
    paramKeys.forEach(([k, def])=>{
      const input = document.getElementById("param_"+k);
      const span  = document.getElementById("val_"+k);
      if (!input || !span) return;
      const v = (params && params[k] !== undefined) ? params[k] : def;
      input.value = v;
      span.textContent = (""+v).includes(".") ? Number(v).toFixed(2) : v;
    });
  }
  function readParamUI(){
    const o = {};
    paramKeys.forEach(([k])=>{
      const v = document.getElementById("param_"+k).value;
      o[k] = (""+v).includes(".") ? parseFloat(v) : parseInt(v,10);
    });
    return o;
  }
  paramKeys.forEach(([k])=>{
    const input = document.getElementById("param_"+k);
    const span  = document.getElementById("val_"+k);
    if (input && span){
      input.addEventListener("input", ()=>{
        const v = input.value;
        span.textContent = (""+v).includes(".") ? Number(v).toFixed(2) : v;
        markDirty();
      });
    }
  });

  /* ---------- Boot ---------- */
  window.addEventListener("DOMContentLoaded", boot);
  function boot(){
    const q = new URLSearchParams(location.hash.replace(/^#\??/, ''));
    els.clientId.value = (q.get("client") || "").toUpperCase();
    els.behavior.value = (q.get("behavior") || "BASE").toUpperCase();
    els.apiBase.value  = q.get("api") || DEV_API;

    renderFileList();

    window.addEventListener("keydown", (e)=>{
      if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="s"){ e.preventDefault(); saveCurrent(); }
    });

    els.search.addEventListener("input", ()=>{
      const kw = els.search.value.toLowerCase();
      [...els.fileList.children].forEach(it=>{
        const t = it.querySelector(".name").textContent.toLowerCase();
        it.style.display = t.includes(kw) ? "" : "none";
      });
    });

    els.promptEditor.addEventListener("input", markDirty);
  }
  function markDirty(){ dirty = true; }
  function clearDirty(){ dirty = false; }
  window.addEventListener("beforeunload", (e)=>{ if (!dirty) return; e.preventDefault(); e.returnValue=""; });

  /* ---------- File List ---------- */
  async function renderFileList(){
    els.fileList.innerHTML = "";
    const clid = els.clientId.value.trim().toUpperCase();
    const beh  = els.behavior.value.toUpperCase();
    const kinds = Object.keys(KIND_TO_NAME).filter(k=>FAMILY[beh].has(k));

    for (const kind of kinds){
      const name = KIND_TO_NAME[kind];
      const li = document.createElement("div");
      li.className = "fileitem";
      li.dataset.kind = kind;
      li.innerHTML = `<div class="name" title="${name}">${name}</div><div class="meta"><span class="chip">checking…</span></div>`;
      els.fileList.appendChild(li);

      const clientPath = `client/${clid}/${name}`;
      const legacyPath = `prompt/${clid}/${name}`;
      const template   = behaviorTemplatePath(beh, kind);

      const state = await resolveState([clientPath, legacyPath], template);
      const chip  = li.querySelector(".chip");
      if (state === "client") { chip.textContent = "Overridden"; chip.classList.add("ok"); }
      else if (state === "legacy"){ chip.textContent = "Overridden (legacy)"; chip.classList.add("ok"); }
      else if (state === "template"){ chip.textContent = "Template"; chip.classList.add("info"); }
      else { chip.textContent = "Missing"; chip.classList.add("warn"); }

      li.addEventListener("click", ()=> openKind(kind));
    }
  }
  function behaviorTemplatePath(beh, kind){
    const base = KIND_TO_NAME[kind];
    if (beh === "TYPE-R") return base.replace("texel-", "texel-r-");
    if (beh === "TYPE-S") return base.replace("texel-", "texel-s-");
    return base;
  }

  /* ---------- Load ---------- */
  async function tryLoad(filename){
    const url = join(els.apiBase.value, "LoadPromptText") + `?filename=${encodeURIComponent(filename)}`;
    const res = await fetch(url, { cache: "no-store" }).catch(()=>null);
    if (!res || !res.ok) return null;
    const etag = res.headers.get("etag") || null;
    let data = {};
    try { data = await res.json(); } catch { data = {}; }
    return { data, etag };
  }
  async function resolveState(clientCandidates, templatePath){
    for (const c of clientCandidates){
      const r = await tryLoad(c);
      if (r) return c.includes("/prompt/") ? "legacy" : "client";
    }
    if (await tryLoad(templatePath)) return "template";
    return "missing";
  }

  async function openKind(kind){
    if (dirty && !confirm("未保存の変更があります。破棄して読み込みますか？")) return;

    currentKind = kind;
    els.diffPanel.hidden = true;
    [...els.fileList.children].forEach(n=>n.classList.toggle("active", n.dataset.kind===kind));
    setStatus("読込中…","orange");

    const clid = els.clientId.value.trim().toUpperCase();
    const beh  = els.behavior.value.toUpperCase();
    const name = KIND_TO_NAME[kind];

    currentFilenameTarget = `client/${clid}/${name}`;
    document.getElementById("fileTitle").textContent = currentFilenameTarget;

    const candidates = [
      `client/${clid}/${name}`,
      `prompt/${clid}/${name}`,
      behaviorTemplatePath(beh, kind)
    ];

    let loaded = null, used = null;
    for (const f of candidates){
      const r = await tryLoad(f);
      if (r) { loaded = r; used = f; break; }
    }
    const templ = await tryLoad(behaviorTemplatePath(beh, kind));
    templateText = templ ? JSON.stringify(templ.data, null, 2) : "";

    if (!loaded){
      currentEtag = null;
      els.promptEditor.value = "";
      loadedParams = {};
      writeParamUI(loadedParams);
      setBadges("Missing（新規）", null);
      setStatus("新規作成できます。右上の保存で client 配下に作成します。");
      clearDirty();
      return;
    }

    const d = loaded.data || {};
    let promptText = "";
    if (typeof d.prompt === "string") promptText = d.prompt;
    else if (d.prompt && typeof d.prompt.text === "string") promptText = d.prompt.text;
    else if (typeof d === "string") promptText = d;
    else promptText = JSON.stringify(d, null, 2);

    els.promptEditor.value = promptText;
    loadedParams = d.params || {};
    writeParamUI(loadedParams);

    currentEtag = (used.startsWith("client/") || used.startsWith("prompt/")) ? loaded.etag : null;

    if (used.startsWith("client/")) setBadges("Overridden", currentEtag, "ok");
    else if (used.startsWith("prompt/")) setBadges("Overridden (legacy)", currentEtag, "ok");
    else setBadges("Template（未上書き）", loaded.etag || "—", "info");

    setStatus("読み込み完了","green");
    clearDirty();
  }

  /* ---------- Save ---------- */
  els.btnSave.addEventListener("click", saveCurrent);
  async function saveCurrent(){
    if (!currentFilenameTarget) return;
    const prompt = els.promptEditor.value;
    const params = readParamUI();
    const body = { filename: currentFilenameTarget, prompt, params, etag: currentEtag || undefined };

    setStatus("保存中…","orange");
    try{
      const r = await fetch(join(els.apiBase.value, "SavePromptText"), {
        method:"POST",
        headers:{ "Content-Type":"application/json; charset=utf-8" },
        body: JSON.stringify(body)
      });
      const raw = await r.text(); let json={}; try{ json = raw?JSON.parse(raw):{} }catch{}
      if (!r.ok) throw new Error(json?.error || raw || `HTTP ${r.status}`);

      currentEtag = json?.etag || currentEtag || null;
      setBadges("Overridden", currentEtag, "ok");
      setStatus("保存完了","green");
      clearDirty();
      renderFileList();
    }catch(e){
      setStatus("保存失敗: " + e.message, "red");
      if (String(e).includes("412")) alert("他の人が更新しました。再読み込みしてから保存してください。");
    }
  }

  /* ---------- Diff ---------- */
  els.btnDiff.addEventListener("click", ()=>{
    els.diffLeft.value  = templateText || "(テンプレートなし)";
    els.diffRight.value = els.promptEditor.value || "";
    els.diffPanel.hidden = !els.diffPanel.hidden;
  });

  /* ---------- Utils ---------- */
  function setStatus(msg, color="#0AA0A6"){ els.status.style.color = color; els.status.textContent = msg; }
  function setBadges(stateText, etag, mode){
    els.badgeState.textContent = stateText;
    els.badgeState.className = "chip " + (mode||"");
    els.badgeEtag.textContent = etag || "—";
  }
  function join(base, path){ return (base||"").replace(/\/+$/,"") + "/" + String(path||"").replace(/^\/+/,""); }
  </script>
</body>
</html>
